#!/bin/sh
#
# Usage:
#   hoy <vimwiki_diary_directory>
# 
# Hoy, creates the vimwiki diary for today, based on the last day found
# 
# It also performs cleaning on the tomorrow's pad:
#
#   - Restarts pomodoro counters in the form: *\\d* to *0*
#   - Removes tasks that were completed: - [X]
# 

readonly diaryDirectory=${1:-"$HOME/wikies/raw/fitbit/diary"}
readonly today=$(date +'%Y-%m-%d')

if [ -f "$diaryDirectory/$today.wiki" ]
then
  echo "$0: File '$diaryDirectory/$today.wiki' exists, aborting for today."
  exit 0
fi

# Given a directory prints the last day for which a file is found.
function get_last_written_day() {
  local readonly dirname=$1

  find -E $dirname -type f -iregex ".*[0-9]{4}-[0-9]{2}-[0-9]{2}.wiki$" \
    | sed -E -e 's/^.*([0-9]{4}-[0-9]{2}-[0-9]{2}).wiki$/\1/' \
    | sort -n \
    | tail -n 1
}

# Given a day, returns a test for the header like "= Monday ="
function get_day_header() {
  local readonly day=$1

  case $(date -j -f'%Y-%m-%d' $day +'%u') in
    1)
      echo "= Lunes = "
      ;;
    2)
      echo "= Martes = "
      ;;
    3)
      echo "= Miercoles = "
      ;;
    4)
      echo "= Jueves = "
      ;;
    5)
      echo "= Viernes = "
      ;;
    6)
      echo "= Sabado = "
      ;;
    7)
      echo "= Sunday = "
      ;;
  esac
}

readonly lastWrittenDay=$(get_last_written_day $diaryDirectory)
readonly nextDayHeader=$(get_day_header $today)

(echo $nextDayHeader && \
  cat $diaryDirectory/$lastWrittenDay.wiki \
    | sed -E -e 's;\*[0-9]\*;*0*;' \
    | sed -e '/\[X\]/d' \
    | sed -E -e 's;\[[.oO]\];[ ];' \
    | sed '1d') > $diaryDirectory/$today.wiki

### - CASO DE USO TOP: aplicando las sanitizaciones y dado el directorio: crea archivo para dia siguiente
### - CASO DE USO TOP: sanitizazdo de archivo generado (eliminacion de tareas completadas, reset de pomodoros)

### - CASO DE USO MED: dado un diractorio de vimwiki, quiero saber cual fue el ultimo dia escrito
  ### - listar los archivos del directorio
  ### - filtrar solo los dias
  ### - ordenar esa lista 
  ### - ordenar los dias
  ### - obtener el ultimo o el primero, el ultimo dia escrito
### - CASO DE USO MED: dado un dia cualquiera, quiero saber cual es el dia habil siguiente
  ### - ver que dia era (lunes, martes miercoles, jueves)
  ### - dar el dia siguiente
